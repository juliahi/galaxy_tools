<tool id="deseq_with_count" name="Count reads and run DESeq" version="2.0.1">
<requirements>
    <requirement type="python-module">pysam</requirement>
    <requirement type="R-module">DESeq</requirement>
</requirements>

  <description>Counts paired-end reads mapped to genes or exons on specific strand and run DESeq</description>
  <command interpreter="bash"> deseq_with_count.sh $annotation $output1 $output2 $output3 
\${GALAXY_SLOTS:-4}
$fittype
-b 
#for $b in $treated_bams
  "${b.tbam_filep.file_name}"
  "${b.tbam_filep.metadata.bam_index}"
  "${b.tbam_filem.file_name}"
  "${b.tbam_filem.metadata.bam_index}"
  #if str($b['fname']) == ""
    'data ${b.tbam_filep.hid} and ${b.tbam_filem.hid}'
  #else
    "${b.fname}"
  #end if

#end for
-u 
#for $b in $untreated_bams
  "${b.ubam_filep.file_name}"
  "${b.ubam_filep.metadata.bam_index}"
  "${b.ubam_filem.file_name}"
  "${b.ubam_filem.metadata.bam_index}"
  #if str($b['fname']) == ""
    'data ${b.ubam_filep.hid} and ${b.ubam_filem.hid}'
  #else
    "${b.fname}"
  #end if
#end for
#if $block.counting=="exons"
  -e
#end if
#if $block.counting=="transcripts"
  -t 
#end if
#if $block.counting=="genes"
  $block.introns
#end if

</command>
  <inputs>
    <repeat name="treated_bams" title="Input TREATED bam files" min="1" default="1">
      <param name="tbam_filep" label="Input bam file - plus reads" format="bam" type="data" data_ref="bam_file"  />
      <param name="tbam_filem" label="Input bam file - minus reads" format="bam" type="data" data_ref="bam_file" />
      <param name="fname" label="Track name" type="text"/>
    </repeat>
    <repeat name="untreated_bams" title="Input UNTREATED bam files" min="1" default="1">
      <param name="ubam_filep" label="Input bam file - plus reads" format="bam" type="data" data_ref="bam_file"  />
      <param name="ubam_filem" label="Input bam file - minus reads" format="bam" type="data" data_ref="bam_file" />
      <param name="fname" label="Track name" type="text"/>
    </repeat>

    <param format="tabular" name="annotation" type="data" optional="false" label="Genome or region annotation"/>
    <conditional name="block">
        <param name="counting" type="select" label="Count hits on:">
            <option value="exons" selected="true">Exons</option>
            <option value="genes">Genes</option>
            <option value="transcripts">Transcripts</option>    
        </param>
            <when value="genes">
                <param name="introns" type="boolean" truevalue="-i" falsevalue="" help="count reads mapped to introns" />
            </when>
    </conditional>

    <param name="fittype" type="select" label="DESeq estimate dispersion parameter fitType">$
      <option value="parametric">Parametric (default)</option>$
      <option value="local">Local (mandatory for only one condition or lack of repeats)</option>$
    </param>$
    
  </inputs>
  <outputs>
        <data format="tabular" name="output1" label="${tool.name} on ${on_string}: counts"/>
        <data format="tabular" name="output2" label="${tool.name} on ${on_string}: DESeq results"/>
        <data format="pdf" name="output3" label="${tool.name} on ${on_string}: results summary in pdf"/>
    
  </outputs>

  <tests>
  </tests>

  <help>
Count reads mapped to exons, transcripts or genes. Count both reads from paired-end sequencing as one hit. Perform differential expression analysis with DESeq.
One can choose to count reads mapped entirely to introns as counts for genes (default: count only reads overlaping exons).

Requires annotation in format: 

seq_id chromosome strand start end exon_starts exon_ends human_readable_gene_name

Author: Julia
  </help>

</tool>

